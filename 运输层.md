# 第五章　　　运输层

关键点：Tcp/Ip协议簇运输层重要的Tcp,Udp协议。

##　一
1.1   网络主机进行通讯，只有进行通讯的两个主机的协议栈才有运输层，而网络核心部分的路由器在转发分组的时候都只有下三层的功能。

ip协议解决的问题是把进行通讯的源主机发出的分组按照首部中的目的地址交到目的主机（ip数据报首部明确标志了这两个主机的ip地址），但这个还往往不够，因为真正进行通讯的是主机中的进程。

**两个主机进行通讯实际上就是两个主机中的应用进程的互相通讯,也就端的通讯实际上是应用进程间的通讯**

网络层是为主机之间提供逻辑通信，而运输层是为应用进程之间提供端到端的逻辑通信

1.2 
用户数据报协议　UDP(udp用户数据报)
传输控制协议　　TCP(传输的数据单元：tcp报文段)

TCP　提供面向连接的服务，在传送数据之前必须先建立好连接，数据传送结束后要释放连接。tcp不提供广播或者多播服务，由于tcp要提供可靠的，面向连的服务，所以开销比较大，如确认，流量控制，计时器以及连接管理，这使得协议数据单元的首部增大了很多，同时还要占用许多处理机资源。

运输层的主要功能：复用和分用

计算机中的进程是通过进程标识符来标志的，可在互联网的环境下，用计算机操作系统指派的进程标识符来标志运行在应用层的各种应用进程是不行的。因为因特网上的计算机的操作系统种类很多，而不同操作系统又使用不同格式的进程标识符。为了解决这个问题就必须采用统一的方法来对Tcp/ip体系的用用进程进行标志。
同时因为进程的创建和撤销都是动态的，通信的彼此几乎无法识别对方的进程。我们主要是利用目的主机提供的功能来识别终点，而不需要知道具体实现这个功能的进程是哪一个。为了解决这个问题就在运输层引入了协议端口号。也就是说通信的终点是应用进程，但我们只要把传送的报文交到目的主机的某个端口就可以了，剩下的工作Tcp可以完成。

这也就是端口的由来。

协议层间的抽象的协议端口是软件端口，是应用层的各种协议进程和运输实体进行层间交互的一种地址。

计算机中的进程要相互通信，需要知道对方的ip地址和端口号

端口的分类：
      1. 服务器　
　　　系统端口号：数值０～1023
    　　登记端口号：数值1024 ~ 49151
       2. 客户端
              数值：　49152 ~ 65535

## 二
1.   udp概述
用户数据报协议udp 只是在ip数据报服务之上增加(复用和分用，差错检测的功能)很少的功能。
udp主要特点：
　　　　　　1. udp是无连接的，也就是发送数据之前不需要建立连接（结束后也不需要释放），因此可以减少开销和发送数据之前的延迟
　　　　　　2. udp 使用尽最大努力交付，也就是不保证可靠交付，因此主机不需要维持复杂的连接状态
　　　　  3. udp　是面向报文的。　发送方的udp对应用程序交下来的报文在首部后就交个ip层。不拆分也不和并，也就是说应用层交给udp多长的报文，udp就照样发送，一次发送一个报文，
　　接收方的udp,对ip层交上来的udp用户数据报，在去除首部后就原封不动的交给上层的应用进程。也就是一次交付一个完整的报文。
　　因此应用程序必须选择合适大小的报文。太长太短都会造成效率底下
　　　　　　　　　如图:
           ![](http://dongfeng.qiniudn.com/udp_send.png)

     　 　udp没有拥塞控制，网络上的拥塞不会使源主机的发送频率降低
　　　　　　　 udp 支持一对一，一对多，多对一和多对多的交互通信
　　　　　　  udp首部开销小，只需要８个字节，tcp需要20个字节

2. udp 的首部格式
　用户数据报组成：　数据字段和首部字段
　首部字段（8个字节）　由四个字段组成，每个字段长度都是连个字节
　　　源端口　
　　　目的端口　　　必须有
　　　长度　　　　　udp用户数据报的长度，最小值８仅有首部
　　　校验和　　　　检验udp用户数据报在传输中是否有错有错就丢弃

　　　校验和的具体计算方法不在详细叙述　　　　　　　　
# 三　传输控制协议Tcp概述
　　　tcp协议特点：
　　　       1 . tcp是面向连接的运输层协议。也就是说应用程序在使用tcp协议之前必须先建立连接，在传送数据完毕后必须释放已经建立的tcp连接
　　　　　　　　　　2. 每一条tcp连接只能有两个端点。
　　　　　　　   3. tcp提供可靠交付的服务。通过tcp连接传送的数据无差错，不丢失，不重复，并且按序到达。
　　　　　　　　　 4. tcp 提供全双工通信。tcp 允许通信双方的应用进程在任何时候都能发送数据，tcp连接的两端都设有发送缓存和接收缓存，用来临时存放双向通信的数据。
　　　　　　　  5.面向字节流。
　　　　　　　　　　　　　tcp和udp在发送报文时候采用的方式完全不同。tcp对应用进程一次把多长的报文发送到tcp的缓存中是不关心的。tcp根据对方给出的窗口值和当前网络的拥塞程度来决定一个报文段应该包含多少个字节。（udp发送的报文长度是应用进程给出的。
　　如果应用进程发送到Tcp缓存的数据块太长，tcp可以划分的短一些在传送。反之，可以积累到有足够多之后再发送


　　　　tcp　连接
　每一条tcp连接有两个端点。Tcp连接的端点叫做套接字(socket).根据RFC793的定义：端口号拼接到ip地址即构成套接字。表示方法：点分十进制的ip地址后加上端口号，中间用冒号或者逗号隔开。例如：　192.3.4.5:80
![](http://dongfeng.qiniudn.com/socket.png)
    每一条tcp连接唯一地被通信两端的两个端点（也就是两个套接字）所确定

# 四　可靠传输的工作原理

tcp发送的报文段是交给ip层传达的，但是ip层只供尽最大努力交付。因此tcp下面的网络提供的是不可靠的传输。因此tcp必须采取适当的措施才能使两个运输层之间的通信变得可靠。

　　　1.停止等待协议
　　停止等待就是每发送完一个分组就停止发送等带对方的确认。在收到确认后再发送下一个分组。
　　无差错情况就是正常进行，有差错的就会超时重传。
　　特点：简单，信道利用率底下
　　　　2. 连续ARQ协议
　　概念：发送窗口（几个分组处于一个发送窗口）
　　这样发送窗口的分组就可以连续的发送出去，而不需要等待对方的确认，提高信道利用率。　
　　　      发送方每收到一个确认，就把发送窗口详情移动一个分组的位置。
　　接收方一般采用累积确认的方式，接收方不必对收到的分组逐个发送确认，而是在收到几个分组后，对按序到达的最后
一个分组进行发送确认。这样就表示到这个分组为止的所有分组都已经正确收到了。
　　优点：容易实现，即使确认丢失也不必重传。
　　缺点：不能向反应发送方反应接收方已经正确接收到的所有分组信息。

＃　五　TCP 报文段的首部格式
　　　　　　　　　　tcp是面向字节流的，但tcp传送的数据单元却是报文段。
　　一个tcp报文段分为首部和数据部分，tcp全部功能体现在它的首部的各字段的作用
　　　　　　　　　tcp报文段首部的前20个字节是固定的。后边4n个字节是根据需要而增加的选项。所以tcp首部的最小长度是20字节。
　　　　　　　

　　     1.源端口和目的端口　各占2个字节。
　　　　　　　2.序号　　占4个字节范围(0, 2^32-1)个序号。序号增加到2^32-1后下一个序号就又回到０．
　　　　　　　　　　　　　　　　　　　tcp是面向字节流的意思是在一个tcp连接中传送的字节流中的每一个字节都按顺序编号。整个要传送的自节流的起始序号必须在连接建立时候设置。这里的需要字段表示本报文段所发送的数据的第一个字节的序号。
　　　　　　3.确认号　占四个字节是期望对方下一个报文段的第一个数据字节的字节号
　　　　　4. 数据偏移。　占４位，tcp报文段的数据起始处距离tcp报文段的起始处有多远。也就是tcp报文段的首部长度。
      5. 保留　　　　占６位。
　　　　 7. 紧急urg 也就是可以插队传输的数据。
　　　　　8. 确认ack 当ack=1的时候确认号字段才有效。tcp规定，在连接建立后所有传送的报文段都必须把ack置１
　　　　9. 推送psh
     10. 复位rst 等于１的时候表示ｔｃｐ连接出现严总差错，需要释放连接重新建立运输连接。
　　　　　　11.同步syn
      12. 终止fin. 用来释放一个连接。当等于１时候，表示此报文段的发送方的数据已经发送完毕，要求释放运输连接。
　　　　　　13. 窗口　窗口是发送报文段的一方的接受窗口，告诉对方，从报文段首部中的确认号算起，接收方目前允许对方发送的数据量。因为接收方的数据缓存空间有限。
     14.校验和　占2个字节。校验包括首部和数据两部分。
　　　　　　15.紧急指针。
　　　　　　16.选项。
　　　　　　　　　　 例如：最大报文段的长度ｍss.指每一个tcp报文段的数据字段的最大长度。






















